# データベース基礎知識

このドキュメントでは、データベースとは何か、このプロジェクトでどう使われているかを初心者向けに説明します。

## 📊 データベースとは？

**データベース**は、データ（情報）を保存しておく場所です。Excelの表のようなものだと思ってください。

### 身近な例

- **電話帳**：名前と電話番号を保存
- **住所録**：名前と住所を保存
- **Todoアプリ**：Todoリストとアイテムを保存

これらはすべて「データを整理して保存する」という点でデータベースと同じです。

### データベースのメリット

1. **大量のデータを保存できる**：何千、何万件のデータでも保存可能
2. **検索が速い**：特定のデータを素早く見つけられる
3. **データの整合性を保てる**：間違ったデータが入らないようにできる
4. **複数の人で共有できる**：同じデータを複数の人が使える

---

## 📚 データベースの基本用語

データベースを理解するために、まず基本的な用語を覚えましょう。

### データベース（DB）

**データベース**は、データを保存する**大きな箱**のようなものです。

- 1つのデータベースの中に、複数のテーブルを保存できます
- このプロジェクトでは、`todo`という名前のデータベースを使っています

**例え**：

- データベース = Excelファイル全体（例：`todo.xlsx`）
- テーブル = Excelファイルの中の1つのシート（例：「リスト一覧」シート、「アイテム一覧」シート）

### テーブル

**テーブル**は、データを整理した**表**です。Excelのシートのようなものです。

- 1つのテーブルには、同じ種類のデータを保存します
- このプロジェクトには、`lists`テーブルと`items`テーブルの2つがあります

**例え**：

- テーブル = Excelのシート
- `lists`テーブル = 「リスト一覧」というシート
- `items`テーブル = 「アイテム一覧」というシート

### カラム（列）

**カラム**は、テーブルの**縦の列**です。データの種類を表します。

- 1つのテーブルには、複数のカラムがあります
- 例：`lists`テーブルには、`id`、`name`、`sortOrder`などのカラムがあります

**例え**：

- カラム = Excelの列（A列、B列、C列など）
- `name`カラム = 「リスト名」という列

### レコード（行）

**レコード**は、テーブルの**横の行**です。1件のデータを表します。

- 1つのテーブルには、複数のレコードがあります
- 例：`lists`テーブルには、複数のリスト（レコード）が保存されています

**例え**：

- レコード = Excelの行（1行目、2行目、3行目など）
- 1つのレコード = 「買い物リスト」という1件のデータ

### まとめ

```
データベース（todo）
  └─ テーブル（lists）
      ├─ カラム：id, name, sortOrder, ...
      └─ レコード：
          ├─ 1行目：id=abc-123, name=買い物リスト, ...
          ├─ 2行目：id=def-456, name=仕事のタスク, ...
          └─ ...
```

---

## 🗄️ このプロジェクトでのデータベース

このTodoアプリでは、**PostgreSQL**というデータベースを使っています。

### データベースの構造

データベースの中には、**テーブル**（表）があります。このプロジェクトには2つのテーブルがあります：

#### 1. `lists` テーブル（リスト）

Todoリストを保存するテーブルです。

**カラム（列）**：

| id      | name         | sortOrder | createdAt  |
| ------- | ------------ | --------- | ---------- |
| abc-123 | 買い物リスト | 0         | 2024-01-01 |
| def-456 | 仕事のタスク | 1         | 2024-01-02 |

↑ カラム（列）  
← レコード（行）

- **id**カラム：リストを識別するためのユニークな番号
- **name**カラム：リストの名前（例：「買い物リスト」）
- **sortOrder**カラム：並び順
- **createdAt**カラム：作成日時

**レコード（行）**：

- 1行目：id=abc-123, name=買い物リスト, ...（1件のリストデータ）
- 2行目：id=def-456, name=仕事のタスク, ...（1件のリストデータ）

#### 2. `items` テーブル（アイテム）

Todoアイテムを保存するテーブルです。

**カラム（列）**：

| id      | listId  | title      | isDone | createdAt  |
| ------- | ------- | ---------- | ------ | ---------- |
| xyz-789 | abc-123 | 牛乳を買う | false  | 2024-01-01 |
| uvw-012 | abc-123 | パンを買う | true   | 2024-01-01 |

↑ カラム（列）  
← レコード（行）

- **id**カラム：アイテムを識別するためのユニークな番号
- **listId**カラム：どのリストに属しているか（`lists`テーブルの`id`とつながっている）
- **title**カラム：アイテムの内容（例：「牛乳を買う」）
- **isDone**カラム：完了したかどうか（`true`=完了、`false`=未完了）
- **createdAt**カラム：作成日時

**レコード（行）**：

- 1行目：id=xyz-789, listId=abc-123, title=牛乳を買う, ...（1件のアイテムデータ）
- 2行目：id=uvw-012, listId=abc-123, title=パンを買う, ...（1件のアイテムデータ）

### テーブル同士の関係

`lists`テーブルと`items`テーブルは**関連**しています：

- 1つのリスト（`lists`）には、複数のアイテム（`items`）が含まれる
- 1つのアイテム（`items`）は、必ず1つのリスト（`lists`）に属している

```
リスト「買い物リスト」
  ├─ アイテム「牛乳を買う」
  ├─ アイテム「パンを買う」
  └─ アイテム「卵を買う」
```

---

## 📝 SQLクエリとは？

データベースを操作するには、**SQL**（Structured Query Language）という専用の言語を使います。SQLで書かれた命令を**SQLクエリ**と呼びます。

### SQLクエリの例

データベースからデータを取得する場合、SQLクエリは次のようになります：

```sql
-- すべてのリストを取得
SELECT * FROM lists;

-- 特定のリストを取得
SELECT * FROM lists WHERE id = 'abc-123';

-- 新しいリストを作成
INSERT INTO lists (name) VALUES ('買い物リスト');

-- リスト名を更新
UPDATE lists SET name = '新しいリスト名' WHERE id = 'abc-123';

-- リストを削除
DELETE FROM lists WHERE id = 'abc-123';
```

### SQLクエリの特徴

- **データベース専用の言語**：JavaScriptとは別の言語なので、覚える必要がある
- **文字列として書く**：コードの中で文字列として書くため、タイプミスに気づきにくい
- **型チェックがない**：間違ったカラム名を書いても、実行するまでエラーに気づけない

---

## 🔧 Prisma とは？

**Prisma**は、データベースを操作するためのツール（ORM）です。SQLクエリを書かなくても、JavaScriptのコードでデータベースを操作できます。

### SQLとPrismaの違い

#### SQLクエリで書く場合

```sql
-- SQLクエリを文字列として書く
SELECT * FROM lists WHERE id = 'abc-123';
```

#### Prismaで書く場合

```typescript
// JavaScriptのコードとして書く
const list = await prisma.list.findUnique({
  where: { id: "abc-123" },
});
```

### Prismaを使うメリット

1. **JavaScript/TypeScriptで書ける**：SQLを覚えなくても、慣れ親しんだJavaScriptで書ける
2. **型安全性がある**：TypeScriptの型チェックで、間違ったコードを書くとエラーが出る
3. **自動補完が効く**：エディタが候補を出してくれるので、タイプミスを防げる
4. **読みやすい**：SQLクエリよりも、コードとして読みやすい

### 具体例：リストを取得する

#### SQLクエリの場合

```sql
SELECT * FROM lists WHERE archived_at IS NULL ORDER BY sort_order ASC;
```

- 文字列なので、タイプミスがあっても実行するまで気づけない
- カラム名を間違えてもエラーが出ない

#### Prismaの場合

```typescript
const lists = await prisma.list.findMany({
  where: {
    archivedAt: null,
  },
  orderBy: {
    sortOrder: "asc",
  },
});
```

- TypeScriptの型チェックで、`archivedAt`や`sortOrder`のスペルミスがあればエラーが出る
- エディタが自動補完してくれる
- コードとして読みやすい

### Prismaの役割

1. **データベースの構造を定義**：どんなテーブルがあるか、どんなデータを保存するかを定義
2. **データベース操作を簡単にする**：JavaScriptのコードでデータベースを操作できる
3. **型安全性を提供**：TypeScriptで型エラーを防げる

### Prismaのファイル

#### `prisma/schema.prisma`

データベースの構造を定義するファイルです。

```prisma
model List {
  id        String     @id @default(uuid())
  name      String
  items     Item[]
}

model Item {
  id        String    @id @default(uuid())
  listId    String
  title     String
  isDone    Boolean   @default(false)
  list      List      @relation(fields: [listId], references: [id])
}
```

このファイルで「どんなテーブルがあるか」「どんなデータを保存するか」を定義します。

#### `app/repository/` フォルダ

データベースを操作するコードが入っています。

- **`list.repository.ts`**：リストの作成・取得・更新・削除
- **`item.repository.ts`**：アイテムの作成・取得・更新・削除

---

## 💾 データベース操作の基本

### CRUD操作

データベースの操作は、基本的に4つの操作（CRUD）に分けられます：

| 操作       | 英語     | 説明               | 例                 |
| ---------- | -------- | ------------------ | ------------------ |
| **C**reate | 作成     | 新しいデータを追加 | 新しいリストを作る |
| **R**ead   | 読み取り | データを取得       | リスト一覧を表示   |
| **U**pdate | 更新     | データを変更       | リスト名を変更     |
| **D**elete | 削除     | データを削除       | リストを削除       |

### 実際のコード例

#### Create（作成）

```typescript
// 新しいリストを作成
await listRepository.create({
  name: "買い物リスト",
});
```

#### Read（読み取り）

```typescript
// すべてのリストを取得
const lists = await listRepository.findAll();

// 特定のリストを取得
const list = await listRepository.findById("abc-123");
```

#### Update（更新）

```typescript
// リスト名を更新
await listRepository.update("abc-123", {
  name: "新しいリスト名",
});
```

#### Delete（削除）

```typescript
// リストを削除
await listRepository.delete("abc-123");
```

---

## 🔄 マイグレーションとは？

**マイグレーション**は、**実際のデータベースの構造を変更する**作業です。

### なぜ必要？

データベースの構造を変更するとき（例：新しいカラムを追加する）は、**実際のデータベース**（PostgreSQL）の構造も変更する必要があります。

**重要なポイント**：

- `prisma/schema.prisma`は**定義ファイル**（設計図）です。これを変更しただけでは、実際のデータベースは変わりません
- **マイグレーションを実行**することで、実際のデータベースの構造が変更されます

### マイグレーションの流れ

1. **`prisma/schema.prisma`を編集**：データベースの構造を「定義」する（設計図を書く）
   - この時点では、まだ実際のデータベースは変わっていません
2. **マイグレーションを実行**：`npx prisma migrate dev --name 変更内容`
   - このコマンドで、**実際のデータベース**（PostgreSQL）の構造が変更されます
   - データベースに新しいカラムが追加されたり、テーブルが作成されたりします
3. **データベースが更新される**：実際のデータベースが新しい構造になります

### 例：新しいカラムを追加する場合

#### 1. `schema.prisma`を編集（定義を変更）

```prisma
model List {
  id        String     @id @default(uuid())
  name      String
  color     String?    // ← 新しいカラムを追加（定義のみ）
  // ...
}
```

**この時点では**：

- `schema.prisma`ファイルに`color`カラムの定義が追加されただけ
- **実際のデータベースにはまだ`color`カラムは存在しない**

#### 2. マイグレーションを実行（実際のデータベースを変更）

```bash
npx prisma migrate dev --name add_color_to_list
```

**このコマンドを実行すると**：

- **実際のPostgreSQLデータベース**に`color`カラムが追加されます
- データベースの`lists`テーブルに、新しい`color`カラムが作成されます
- これで、実際にデータベースの構造が変わりました

**確認方法**：

マイグレーション後、以下のコマンドでデータベースの中身を確認できます：

```bash
npx prisma studio
```

または、PostgreSQLに直接接続して：

```sql
-- listsテーブルの構造を確認
\d lists
```

これで、実際のデータベースに`color`カラムが追加されていることが確認できます。

---

## 🛠️ データベースを確認する方法

### Prisma Studio

データベースの中身をブラウザで確認できるツールです。

```bash
npx prisma studio
```

このコマンドを実行すると、ブラウザが開いてデータベースの中身を確認・編集できます。

### psqlコマンド

PostgreSQLに直接接続して確認することもできます。

```bash
psql -U postgres -d todo
```

PostgreSQLのコマンドでデータを確認できます。

---

## 📝 まとめ

### 基本用語

- **データベース（DB）**：データを保存する大きな箱（このプロジェクトでは`todo`という名前）
- **テーブル**：データを整理した表（`lists`、`items`など）
- **カラム（列）**：テーブルの縦の列。データの種類を表す（`id`、`name`など）
- **レコード（行）**：テーブルの横の行。1件のデータを表す

### ツールと操作

- **Prisma**：データベースを操作するツール（SQLクエリを書かなくても使える）
- **SQLクエリ**：データベースを操作するための専用の言語
- **CRUD**：Create（作成）、Read（読み取り）、Update（更新）、Delete（削除）
- **マイグレーション**：実際のデータベースの構造を変更する作業

---

## 🔗 関連ドキュメント

- [開発ガイド](./開発ガイド.md) - プロジェクトの構造と開発の流れ
- [README.md](../README.md) - セットアップ手順
- [Prisma 公式ドキュメント](https://www.prisma.io/docs) - Prismaの詳細な使い方

---

Happy Learning! 🎓
